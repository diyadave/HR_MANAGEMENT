<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks Management | Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-size: 14px;
            min-height: 100vh;
            display: flex;
            width: 100%;
        }

        /* Sidebar - fixed width */
        #sidebar-container {
            width: 260px;
            flex-shrink: 0;
            background: white;
            border-right: 1px solid #e2e8f0;
            height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
        }

        /* Main content - takes remaining width */
        .main-content {
            flex: 1;
            min-width: 0; /* Prevents flex overflow */
            height: 100vh;
            overflow-y: auto;
            background: #f8fafc;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 24px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #0f172a;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 14px;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 10px 16px 10px 42px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            width: 260px;
            background-color: white;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #073379;
            box-shadow: 0 0 0 3px rgba(7, 51, 121, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }

        /* Button Styles */
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #073379;
            color: white;
        }

        .btn-primary:hover {
            background-color: #052b63;
        }

        .btn-secondary {
            background-color: white;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px 20px;
            background-color: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
        }

        .filter-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background-color: white;
            color: #1e293b;
        }

        .filter-select:focus {
            outline: none;
            border-color: #073379;
        }

        .btn-clear {
            padding: 8px 16px;
            background-color: transparent;
            color: #64748b;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-left: auto;
        }

        .btn-clear:hover {
            background-color: #f8fafc;
        }

        /* Table Styles */
        .table-container {
            background-color: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .table-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .tasks-table thead {
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .tasks-table th {
            padding: 14px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tasks-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .tasks-table tbody tr:hover {
            background-color: #f8fafc;
        }

        /* Task Title */
        .task-title-cell {
            min-width: 240px;
        }

        .task-public-id {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .task-title {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .task-description {
            font-size: 12px;
            color: #64748b;
        }

        /* Project Badge */
        .project-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            background-color: #eef2ff;
            color: #073379;
        }

        /* Assigned Cell */
        .assigned-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #073379, #1e4ab0);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
            display: block;
        }

        .user-avatar.small {
            width: 28px;
            height: 28px;
            font-size: 11px;
        }

        .user-name {
            font-weight: 500;
            color: #1e293b;
        }

        /* Priority Badge */
        .priority-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .priority-high {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .priority-medium {
            background-color: #fef3c7;
            color: #d97706;
        }

        .priority-low {
            background-color: #d1fae5;
            color: #059669;
        }

        /* Status Badge */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #d97706;
        }

        .status-progress {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #059669;
        }

        .status-overdue {
            background-color: #fee2e2;
            color: #dc2626;
        }

        /* Due Date */
        .due-date {
            font-weight: 500;
        }

        .due-overdue {
            color: #dc2626;
        }

        .due-today {
            color: #d97706;
        }

        .due-future {
            color: #059669;
        }

        /* Actions */
        .actions-col {
            text-align: center;
            width: 180px;
            min-width: 180px;
        }

        .actions-cell {
            text-align: center;
            width: 180px;
            min-width: 180px;
            white-space: nowrap;
            padding-left: 12px;
            padding-right: 12px;
        }

        .actions-wrap {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f8fafc;
            border-color: #073379;
            color: #073379;
        }

        .action-edit:hover {
            color: #059669;
            border-color: #059669;
            background: #ecfdf5;
        }

        .action-delete:hover {
            color: #dc2626;
            border-color: #dc2626;
            background: #fef2f2;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 550px;
            max-width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 18px 24px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: white;
            color: #1e293b;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            color: #1e293b;
            background-color: white;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: #073379;
            box-shadow: 0 0 0 3px rgba(7, 51, 121, 0.1);
        }

        .form-control.input-error,
        .form-select.input-error,
        .employee-selector.input-error {
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.12) !important;
        }

        .field-error {
            display: none;
            margin-top: 6px;
            font-size: 12px;
            line-height: 1.3;
            color: #dc2626;
        }

        .field-error.show {
            display: block;
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }

        .employee-selector {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            max-height: 250px;
            overflow-y: auto;
            background-color: white;
        }

        .employee-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .employee-option:hover {
            background-color: #f8fafc;
            border-color: #e2e8f0;
        }

        .employee-option.selected {
            background-color: #eef2ff;
            border: 1px solid #073379;
        }

        .employee-info {
            display: flex;
            flex-direction: column;
        }

        .employee-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .employee-detail {
            font-size: 11px;
            color: #64748b;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8fafc;
            position: sticky;
            bottom: 0;
        }

        .confirm-modal-content {
            width: 380px;
            max-width: 95vw;
        }

        .confirm-modal-content .modal-body {
            padding-top: 18px;
            padding-bottom: 10px;
        }

        .confirm-text {
            font-size: 14px;
            color: #334155;
            line-height: 1.5;
        }

        /* Empty State */
        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #64748b;
            background-color: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 500;
            color: #334155;
        }

        /* Pagination */
        .table-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .pagination-info {
            font-size: 13px;
            color: #64748b;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #334155;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            border-color: #073379;
            color: #073379;
        }

        .page-btn.active {
            background: #073379;
            border-color: #073379;
            color: #fff;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Toast */
        .toast-notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            color: white;
            max-width: 350px;
        }

        .toast-success {
            background: #10b981;
        }

        .toast-warning {
            background: #f59e0b;
        }

        .toast-error {
            background: #ef4444;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            #sidebar-container {
                width: 240px;
            }
            
            .search-input {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            #sidebar-container {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .main-content {
                height: auto;
                overflow-y: visible;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-actions {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .search-input {
                width: 100%;
            }
            
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .btn-clear {
                margin-left: 0;
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
            
            .actions-cell {
                width: auto;
                min-width: 120px;
            }

            .actions-wrap {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar-container"></div>
    
   
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div>
                    <h1 class="page-title">Tasks Management</h1>
                    <p class="page-subtitle">View and manage all tasks across projects</p>
                </div>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="taskSearch" placeholder="Search tasks...">
                    </div>
                    <button class="btn btn-primary" onclick="openCreateTaskModal()">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <label class="filter-label">Project</label>
                    <select class="filter-select" id="filterProject">
                        <option value="">All Projects</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="filterStatus">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Priority</label>
                    <select class="filter-select" id="filterPriority">
                        <option value="">All Priorities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <button class="btn-clear" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>

            <!-- Tasks Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2>All Tasks</h2>
                    <div class="table-controls">
                        <div class="pagination-info" id="tasksCountInfo">0 tasks</div>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="tasks-table">
                        <thead>
                            <tr>
                                <th>Task Title</th>
                                <th>Project</th>
                                <th>Assigned To</th>
                                <th>Priority</th>
                                <th>Due Date</th>
                                <th>Status</th>
                            <th class="actions-col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <!-- Tasks will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="table-footer">
                    <div class="pagination-info" id="tasksRangeInfo">Showing 0 of 0 tasks</div>
                    <div class="pagination-controls" id="tasksPaginationControls"></div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="empty-state-text">No tasks found</div>
                <div class="empty-state-subtext">Try adjusting your filters or create a new task</div>
            </div>
        </div>

        <!-- Create Task Modal -->
        <div id="createTaskModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="taskModalTitle">Create New Task</div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Project *</label>
                        <select class="form-select" id="taskProject" required>
                            <option value="">Select Project</option>
                        </select>
                        <div class="field-error" id="taskProjectError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Task Title *</label>
                        <input type="text" class="form-control" id="taskTitle" placeholder="Enter task title">
                        <div class="field-error" id="taskTitleError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" placeholder="Describe the task..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Assign To *</label>
                        <div class="employee-selector" id="assigneeList"></div>
                        <div class="field-error" id="assigneeListError"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Priority *</label>
                            <select class="form-select" id="taskPriority">
                                <option value="high">High</option>
                                <option value="medium" selected>Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Due Date *</label>
                            <input type="date" class="form-control" id="taskDueDate" max="9999-12-31">
                            <div class="field-error" id="taskDueDateError"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estimated Hours</label>
                        <input type="number" class="form-control" id="taskHours" placeholder="e.g., 8" min="0.5" step="0.5">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" id="taskSaveBtn" onclick="createTask()">Create Task</button>
                </div>
            </div>
        </div>

        <div id="deleteTaskModal" class="modal-overlay">
            <div class="modal-content confirm-modal-content">
                <div class="modal-header">
                    <div class="modal-title">Delete Task</div>
                    <button class="modal-close" onclick="closeDeleteTaskModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="confirm-text" id="deleteTaskText">Do you want to confirm delete this task?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeDeleteTaskModal()">Cancel</button>
                    <button class="btn btn-primary" id="confirmDeleteTaskBtn" style="background:#dc2626;">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../static/js/api.js"></script>
    <script>
        // State management
        let allProjects = [];
        let allEmployees = [];
        let allTasks = [];
        let selectedEmployeeId = null;
        let pendingDeleteTask = null;
        let editingTaskId = null;
        let filteredTasks = [];
        let currentTaskPage = 1;
        const tasksPerPage = 6;

        function getProfileImageUrl(path) {
            if (!path) return "";
            if (path.startsWith("http://") || path.startsWith("https://")) return path;
            const normalized = path.replace(/\\/g, "/").replace(/^\/+/, "");
            return `http://127.0.0.1:8000/${normalized}`;
        }

        // Load sidebar
        function loadSidebar() {
            fetch('../shared/sidebar_admin.html')
                .then(response => {
                    if (!response.ok) throw new Error('Sidebar load failed');
                    return response.text();
                })
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                    setTimeout(() => {
                        document.querySelectorAll('#sidebar-container a').forEach(link => {
                            if (link.textContent.includes('Tasks') || link.href.includes('tasks')) {
                                link.classList.add('active');
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading sidebar:', error);
                    document.getElementById('sidebar-container').innerHTML = `
                        <div style="padding: 24px;">
                            <h3 style="color: #073379; font-weight: 600;">Admin Panel</h3>
                            <ul style="list-style: none; padding: 0; margin-top: 24px;">
                                <li style="padding: 12px 0;"><a href="#" style="color: #073379; font-weight: 600; text-decoration: none;">Tasks</a></li>
                                <li style="padding: 12px 0;"><a href="#" style="color: #64748b; text-decoration: none;">Projects</a></li>
                                <li style="padding: 12px 0;"><a href="#" style="color: #64748b; text-decoration: none;">Employees</a></li>
                            </ul>
                        </div>
                    `;
                });
        }

        // Initialize
        document.addEventListener("DOMContentLoaded", async function () {
            loadSidebar();
            setDefaultDate();

            try {
                // Fetch all required data
                const [projects, employees, tasks] = await Promise.all([
                    API.getAdminProjects(),
                    API.getAdminEmployees(),
                    API.request("/admin/tasks")
                ]);

                allProjects = projects || [];
                allEmployees = employees || [];
                allTasks = tasks || [];

                // Populate filters
                populateProjectFilters();
                applyTaskFilters();

                // Search functionality
                document.getElementById('taskSearch').addEventListener('input', () => applyTaskFilters());
                document.getElementById('filterProject').addEventListener('change', () => applyTaskFilters());
                document.getElementById('filterStatus').addEventListener('change', () => applyTaskFilters());
                document.getElementById('filterPriority').addEventListener('change', () => applyTaskFilters());
                document.getElementById('taskProject').addEventListener('change', () => clearTaskFieldError('taskProject'));
                document.getElementById('taskTitle').addEventListener('input', () => clearTaskFieldError('taskTitle'));
                document.getElementById('taskDueDate').addEventListener('change', () => {
                    clearTaskFieldError('taskDueDate');
                    validateTaskDueDateField({ enforceToday: true });
                });
                const paginationControls = document.getElementById('tasksPaginationControls');
                if (paginationControls) {
                    paginationControls.addEventListener('click', (event) => {
                        const btn = event.target.closest('.page-btn');
                        if (!btn || btn.disabled) return;
                        const page = parseInt(btn.dataset.page, 10);
                        if (!Number.isFinite(page)) return;
                        currentTaskPage = page;
                        applyTaskFilters(true);
                    });
                }

            } catch (err) {
                console.error('Error loading data:', err);
                showToast('Failed to load data', 'error');
            }
        });

        // Populate project filters and dropdown
        function populateProjectFilters() {
            const filterSelect = document.getElementById('filterProject');
            const taskProjectSelect = document.getElementById('taskProject');
            
            filterSelect.innerHTML = '<option value="">All Projects</option>';
            taskProjectSelect.innerHTML = '<option value="">Select Project</option>';
            
            allProjects.forEach(project => {
                // For filter
                const filterOption = document.createElement('option');
                filterOption.value = project.id;
                filterOption.textContent = project.name;
                filterSelect.appendChild(filterOption);
                
                // For modal
                const modalOption = document.createElement('option');
                modalOption.value = project.id;
                modalOption.textContent = project.name;
                taskProjectSelect.appendChild(modalOption);
            });
        }

        function buildTaskDisplayIdMap() {
            const sourceTasks = Array.isArray(allTasks) && allTasks.length ? [...allTasks] : [];
            sourceTasks.sort((a, b) => Number(a.id) - Number(b.id));

            const counters = {};
            const idMap = {};

            sourceTasks.forEach((task) => {
                const project = allProjects.find((p) => Number(p.id) === Number(task.project_id));
                const rawProjectName = String(project?.name || 'project').trim().toLowerCase();
                const projectKey = rawProjectName
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-') || 'project';

                counters[projectKey] = (counters[projectKey] || 0) + 1;
                idMap[Number(task.id)] = `${projectKey}-${counters[projectKey]}`;
            });

            return idMap;
        }

        // Render tasks table
        function renderTasks(tasks) {
            const tbody = document.getElementById('tasksTableBody');
            const emptyState = document.getElementById('emptyState');
            const tableContainer = document.querySelector('.table-container');

            tbody.innerHTML = '';

            if (!tasks || tasks.length === 0) {
                emptyState.style.display = 'block';
                tableContainer.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            tableContainer.style.display = 'block';
            const displayIdMap = buildTaskDisplayIdMap();

            tasks.forEach(task => {
                // Find project by ID
                const project = allProjects.find(p => Number(p.id) === Number(task.project_id));
                
                // Find assignee by ID
                const assignee = allEmployees.find(e => Number(e.id) === Number(task.assigned_to));
                const displayTaskId = displayIdMap[Number(task.id)] || `task-${task.id}`;
                
                // Determine status class
                let statusClass = 'status-pending';
                let statusText = task.status || 'pending';
                
                if (task.status === 'in_progress' || task.status === 'progress') {
                    statusClass = 'status-progress';
                    statusText = 'In Progress';
                } else if (task.status === 'completed') {
                    statusClass = 'status-completed';
                } else if (task.status === 'overdue') {
                    statusClass = 'status-overdue';
                }
                
                // Priority class
                const priorityClass = task.priority === 'high' ? 'priority-high' : 
                                     task.priority === 'medium' ? 'priority-medium' : 'priority-low';
                
                // Due date class
                let dueClass = '';
                if (task.due_date) {
                    const today = new Date().toISOString().split('T')[0];
                    if (task.due_date < today && task.status !== 'completed') dueClass = 'due-overdue';
                    else if (task.due_date === today) dueClass = 'due-today';
                    else dueClass = 'due-future';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="task-title-cell">
                        <div class="task-public-id">${escapeHtml(displayTaskId)}</div>
                        <div class="task-title">${escapeHtml(task.title)}</div>
                        <div class="task-description">${escapeHtml(task.description) || 'No description'}</div>
                    </td>
                    <td><span class="project-badge">${escapeHtml(project?.name || 'No Project')}</span></td>
                    <td>
                        <div class="assigned-cell">
                            <div class="user-avatar small">
                                ${assignee?.profile_image
                                    ? `<img src="${getProfileImageUrl(assignee.profile_image)}" alt="${escapeHtml(assignee?.name || 'User')}" onerror="this.parentElement.textContent='${assignee?.name?.charAt(0).toUpperCase() || '?'}'">`
                                    : `${assignee?.name?.charAt(0).toUpperCase() || '?'}`
                                }
                            </div>
                            <span class="user-name">${escapeHtml(assignee?.name || 'Unassigned')}</span>
                        </div>
                    </td>
                    <td><span class="priority-badge ${priorityClass}">${task.priority || 'medium'}</span></td>
                    <td><span class="due-date ${dueClass}">${task.due_date || '-'}</span></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="actions-cell">
                        <div class="actions-wrap">
                            <button class="action-btn" onclick="viewTaskDetails(${task.id})" title="View Task">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn action-edit" onclick="openEditTaskModal(${task.id})" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn action-delete"
                                    title="Delete Task"
                                    onclick='openDeleteTaskModal(${task.id}, ${JSON.stringify(task.title || "this task")})'>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getTaskPageItems(totalPages, currentPage) {
            if (totalPages <= 7) {
                return Array.from({ length: totalPages }, (_, i) => i + 1);
            }
            if (currentPage <= 3) {
                return [1, 2, 3, 4, "...", totalPages];
            }
            if (currentPage >= totalPages - 2) {
                return [1, "...", totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
            }
            return [1, "...", currentPage - 1, currentPage, currentPage + 1, "...", totalPages];
        }

        function renderTaskPagination(totalItems) {
            const controls = document.getElementById('tasksPaginationControls');
            if (!controls) return;

            const totalPages = Math.max(1, Math.ceil(totalItems / tasksPerPage));
            controls.innerHTML = '';

            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.dataset.page = String(currentTaskPage - 1);
            prevBtn.disabled = currentTaskPage <= 1;
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            controls.appendChild(prevBtn);

            getTaskPageItems(totalPages, currentTaskPage).forEach((item) => {
                if (item === '...') {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.style.padding = '0 4px';
                    dots.style.color = '#94a3b8';
                    dots.style.alignSelf = 'center';
                    controls.appendChild(dots);
                    return;
                }
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn${item === currentTaskPage ? ' active' : ''}`;
                pageBtn.dataset.page = String(item);
                pageBtn.textContent = String(item);
                controls.appendChild(pageBtn);
            });

            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.dataset.page = String(currentTaskPage + 1);
            nextBtn.disabled = currentTaskPage >= totalPages;
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            controls.appendChild(nextBtn);
        }

        function renderTaskListPage() {
            const totalItems = filteredTasks.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / tasksPerPage));

            if (currentTaskPage > totalPages) currentTaskPage = totalPages;
            if (currentTaskPage < 1) currentTaskPage = 1;

            const startIndex = totalItems ? (currentTaskPage - 1) * tasksPerPage : 0;
            const endIndex = Math.min(startIndex + tasksPerPage, totalItems);
            const paged = filteredTasks.slice(startIndex, endIndex);

            renderTasks(paged);

            const countInfo = document.getElementById('tasksCountInfo');
            if (countInfo) {
                countInfo.textContent = `${totalItems} task${totalItems !== 1 ? 's' : ''}`;
            }

            const rangeInfo = document.getElementById('tasksRangeInfo');
            if (rangeInfo) {
                if (!totalItems) {
                    rangeInfo.textContent = 'Showing 0 of 0 tasks';
                } else {
                    rangeInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalItems} tasks`;
                }
            }

            renderTaskPagination(totalItems);
        }

        // Filter tasks
        function applyTaskFilters(keepPage = false) {
            const searchTerm = document.getElementById('taskSearch').value.toLowerCase();
            const projectId = document.getElementById('filterProject').value;
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;

            filteredTasks = allTasks.filter(task => {
                // Search filter
                if (searchTerm) {
                    const project = allProjects.find(p => Number(p.id) === Number(task.project_id));
                    const assignee = allEmployees.find(e => Number(e.id) === Number(task.assigned_to));
                    const matchesSearch = task.title.toLowerCase().includes(searchTerm) ||
                                         (task.description && task.description.toLowerCase().includes(searchTerm)) ||
                                         (project && project.name.toLowerCase().includes(searchTerm)) ||
                                         (assignee && assignee.name.toLowerCase().includes(searchTerm));
                    if (!matchesSearch) return false;
                }
                
                // Project filter
                if (projectId && task.project_id != projectId) return false;
                
                // Status filter
                if (status) {
                    if (status === 'progress' && !['progress', 'in_progress'].includes(task.status)) return false;
                    if (status !== 'progress' && task.status !== status) return false;
                }
                
                // Priority filter
                if (priority && task.priority !== priority) return false;
                
                return true;
            });

            if (!keepPage) currentTaskPage = 1;
            renderTaskListPage();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filterProject').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('taskSearch').value = '';
            applyTaskFilters();
        }

        function setTaskModalMode(isEditMode) {
            const titleEl = document.getElementById('taskModalTitle');
            const saveBtn = document.getElementById('taskSaveBtn');
            if (titleEl) titleEl.textContent = isEditMode ? 'Edit Task' : 'Create New Task';
            if (saveBtn) saveBtn.textContent = isEditMode ? 'Update Task' : 'Create Task';
        }

        function populateTaskModalOptions(selectedProjectId = '', selectedAssigneeId = null) {
            const projectSelect = document.getElementById('taskProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>';
            allProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                if (String(project.id) === String(selectedProjectId || '')) {
                    option.selected = true;
                }
                projectSelect.appendChild(option);
            });

            const assigneeList = document.getElementById('assigneeList');
            assigneeList.innerHTML = '';
            selectedEmployeeId = selectedAssigneeId ? Number(selectedAssigneeId) : null;

            if (allEmployees.length === 0) {
                assigneeList.innerHTML = '<div style="padding: 10px; color: #64748b;">No employees found</div>';
                return;
            }

            allEmployees.forEach(emp => {
                const div = document.createElement('div');
                div.className = 'employee-option';
                div.dataset.empId = emp.id;

                if (Number(emp.id) === Number(selectedEmployeeId)) {
                    div.classList.add('selected');
                }

                div.onclick = function() {
                    document.querySelectorAll('.employee-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedEmployeeId = Number(emp.id);
                    clearTaskFieldError('assigneeList');
                };

                div.innerHTML = `
                    <div class="user-avatar small">
                        ${emp.profile_image
                            ? `<img src="${getProfileImageUrl(emp.profile_image)}" alt="${escapeHtml(emp.name || 'User')}" onerror="this.parentElement.textContent='${emp.name ? emp.name.charAt(0).toUpperCase() : '?'}'">`
                            : `${emp.name ? emp.name.charAt(0).toUpperCase() : '?'}`
                        }
                    </div>
                    <div class="employee-info">
                        <span class="employee-name">${escapeHtml(emp.name)}</span>
                        <span class="employee-detail">${emp.department || emp.designation || 'Employee'}</span>
                    </div>
                `;

                assigneeList.appendChild(div);
            });
        }

        // Open create task modal
        function openCreateTaskModal() {
            editingTaskId = null;
            resetForm();
            setTaskModalMode(false);
            populateTaskModalOptions('', null);

            // Show modal
            document.getElementById('createTaskModal').style.display = 'flex';
            setDefaultDate();
        }

        function openEditTaskModal(taskId) {
            const task = allTasks.find(t => Number(t.id) === Number(taskId));
            if (!task) {
                showToast('Task details not available', 'warning');
                return;
            }

            editingTaskId = Number(task.id);
            resetForm();
            setTaskModalMode(true);
            populateTaskModalOptions(task.project_id, task.assigned_to);

            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskPriority').value = task.priority || 'medium';
            document.getElementById('taskDueDate').value = task.due_date || '';
            document.getElementById('taskHours').value = task.estimated_hours ?? '';

            document.getElementById('createTaskModal').style.display = 'flex';
            setDueDateMin();
        }

        function closeModal() {
            document.getElementById('createTaskModal').style.display = 'none';
            editingTaskId = null;
            setTaskModalMode(false);
            resetForm();
        }

        function resetForm() {
            document.getElementById('taskProject').value = '';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskDueDate').value = '';
            document.getElementById('taskHours').value = '';
            
            selectedEmployeeId = null;
            document.querySelectorAll('.employee-option').forEach(item => {
                item.classList.remove('selected');
            });
            clearTaskFormErrors();
            setDueDateMin();
        }

        function setDefaultDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const year = tomorrow.getFullYear();
            const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const day = String(tomorrow.getDate()).padStart(2, '0');
            document.getElementById('taskDueDate').value = `${year}-${month}-${day}`;
            setDueDateMin();
        }

        function setDueDateMin() {
            const today = new Date().toISOString().split('T')[0];
            const dueDateInput = document.getElementById('taskDueDate');
            if (dueDateInput) {
                dueDateInput.min = today;
                dueDateInput.max = '9999-12-31';
            }
        }

        function parseTaskDate(dateStr) {
            const match = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(dateStr || '').trim());
            if (!match) return null;
            const year = Number(match[1]);
            const month = Number(match[2]);
            const day = Number(match[3]);
            if (!Number.isInteger(year) || !Number.isInteger(month) || !Number.isInteger(day)) return null;
            const parsed = new Date(Date.UTC(year, month - 1, day));
            if (
                parsed.getUTCFullYear() !== year ||
                parsed.getUTCMonth() !== month - 1 ||
                parsed.getUTCDate() !== day
            ) {
                return null;
            }
            return { year, iso: `${match[1]}-${match[2]}-${match[3]}` };
        }

        function validateTaskDueDateField(options = {}) {
            const input = document.getElementById('taskDueDate');
            if (!input) return true;

            const rawValue = String(input.value || '').trim();
            const longYearMatch = /^(\d{5,})-/.exec(rawValue);
            if (longYearMatch) {
                setTaskFieldError('taskDueDate', 'Year must be exactly 4 digits.');
                return false;
            }

            const parsed = parseTaskDate(rawValue);
            const currentYear = new Date().getFullYear();
            if (!parsed) {
                setTaskFieldError('taskDueDate', 'Please enter a valid date in YYYY-MM-DD format.');
                return false;
            }
            if (parsed.year < currentYear) {
                setTaskFieldError('taskDueDate', 'Previous years are not allowed.');
                return false;
            }
            if (options.enforceToday) {
                const today = new Date().toISOString().split('T')[0];
                if (parsed.iso < today) {
                    setTaskFieldError('taskDueDate', 'Due date must be today or an upcoming date.');
                    return false;
                }
            }

            clearTaskFieldError('taskDueDate');
            return true;
        }

        function clearTaskFormErrors() {
            document.querySelectorAll('#createTaskModal .field-error').forEach((el) => {
                el.textContent = '';
                el.classList.remove('show');
            });
            ['taskProject', 'taskTitle', 'taskDueDate', 'assigneeList'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('input-error');
            });
        }

        function setTaskFieldError(fieldId, message) {
            const input = document.getElementById(fieldId);
            const error = document.getElementById(`${fieldId}Error`);
            if (input) input.classList.add('input-error');
            if (error) {
                error.textContent = message;
                error.classList.add('show');
            }
        }

        function clearTaskFieldError(fieldId) {
            const input = document.getElementById(fieldId);
            const error = document.getElementById(`${fieldId}Error`);
            if (input) input.classList.remove('input-error');
            if (error) {
                error.textContent = '';
                error.classList.remove('show');
            }
        }

        // Create task
        async function createTask() {
            clearTaskFormErrors();
            const projectId = document.getElementById('taskProject').value;
            const title = document.getElementById('taskTitle').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const description = document.getElementById('taskDescription').value.trim();
            const hours = document.getElementById('taskHours').value ? parseFloat(document.getElementById('taskHours').value) : null;

            // Validation
            let hasError = false;
            if (!projectId) {
                setTaskFieldError('taskProject', 'Please select a project.');
                hasError = true;
            }
            if (!title) {
                setTaskFieldError('taskTitle', 'Please enter a task title.');
                hasError = true;
            }
            if (!selectedEmployeeId) {
                setTaskFieldError('assigneeList', 'Please select at least one employee.');
                hasError = true;
            }
            if (!dueDate) {
                setTaskFieldError('taskDueDate', 'Please select a due date.');
                hasError = true;
            }
            if (hasError) return;
            if (!validateTaskDueDateField({ enforceToday: true })) return;

            const payload = {
                title: title,
                description: description || '',
                project_id: parseInt(projectId, 10),
                assigned_to: selectedEmployeeId,
                priority: priority,
                due_date: dueDate,
                estimated_hours: hours
            };

            try {
                if (editingTaskId) {
                    await API.updateAdminTask(editingTaskId, payload);
                    showToast('Task updated successfully!', 'success');
                } else {
                    await API.createAdminTask(payload);
                    showToast('Task created successfully!', 'success');
                }
                closeModal();
                
                // Refresh tasks list
                allTasks = await API.request("/admin/tasks");
                applyTaskFilters();
                
            } catch (err) {
                console.error('Error creating task:', err);
                const message = String(err.message || 'Failed to create task');
                if (message.toLowerCase().includes('employee')) {
                    setTaskFieldError('assigneeList', message);
                } else if (message.toLowerCase().includes('project')) {
                    setTaskFieldError('taskProject', message);
                } else if (message.toLowerCase().includes('due date')) {
                    setTaskFieldError('taskDueDate', message);
                } else if (message.toLowerCase().includes('title')) {
                    setTaskFieldError('taskTitle', message);
                } else {
                    setTaskFieldError('taskTitle', message);
                }
            }
        }

        // View task details - redirect to project details page with task view
        function viewTaskDetails(taskId) {
            // Find the task to get its project ID
            const task = allTasks.find(t => t.id === taskId);
            if (task && task.project_id) {
                // Navigate to project details with task selected
                window.location.href = `project_details.html?id=${task.project_id}&task=${taskId}`;
            } else {
                showToast('Task details not available', 'warning');
            }
        }

        function openDeleteTaskModal(taskId, taskTitle) {
            pendingDeleteTask = { id: Number(taskId), title: String(taskTitle || "this task") };
            const text = document.getElementById('deleteTaskText');
            if (text) {
                text.textContent = `Do you want to confirm delete "${pendingDeleteTask.title}" task?`;
            }
            const modal = document.getElementById('deleteTaskModal');
            if (modal) modal.style.display = 'flex';
        }

        function closeDeleteTaskModal() {
            pendingDeleteTask = null;
            const modal = document.getElementById('deleteTaskModal');
            if (modal) modal.style.display = 'none';
        }

        async function confirmDeleteTask() {
            if (!pendingDeleteTask?.id) return;
            const deleteBtn = document.getElementById('confirmDeleteTaskBtn');
            if (deleteBtn) deleteBtn.disabled = true;

            try {
                await API.deleteAdminTask(pendingDeleteTask.id);
                closeDeleteTaskModal();
                allTasks = await API.getAdminTasks();
                applyTaskFilters();
                showToast('Task deleted successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Failed to delete task', 'error');
            } finally {
                if (deleteBtn) deleteBtn.disabled = false;
            }
        }

        // Escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Toast
        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal on outside click
        document.addEventListener('click', function(event) {
            const createModal = document.getElementById('createTaskModal');
            const deleteModal = document.getElementById('deleteTaskModal');
            if (event.target === createModal) {
                closeModal();
            }
            if (event.target === deleteModal) {
                closeDeleteTaskModal();
            }
        });

        document.getElementById('confirmDeleteTaskBtn')?.addEventListener('click', confirmDeleteTask);
    </script>
<script src="../../static/js/admin_header_profile.js"></script>
</body>
</html>




