<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Employee Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        #sidebar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            z-index: 1000;
        }

        

        .main-content {
            margin-left: 260px;
            margin-right: 200px;
            padding: 24px;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .welcome-message {
            font-size: 14px;
            color: #64748b;
        }

        .welcome-message strong {
            color: #073379;
            font-weight: 600;
        }

        /* Compact KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
            line-height: 1;
        }

        .kpi-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 4px;
        }

        /* Dashboard Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: #ffffff;
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            height: 100%;
        }

        .card.compact {
            padding: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
        }

        .card-link {
            font-size: 13px;
            color: #073379;
            text-decoration: none;
            font-weight: 500;
        }

        .card-link:hover {
            text-decoration: underline;
        }

        /* Task List */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #f8fafc;
            transition: background-color 0.2s;
        }

        .task-item:hover {
            background-color: #f1f5f9;
        }

        .task-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-pending { background: #f59e0b; }
        .status-in_progress { background: #3b82f6; }
        .status-completed { background: #10b981; }
        .status-overdue { background: #ef4444; }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-size: 13px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 2px;
        }

        .task-project {
            font-size: 11px;
            color: #64748b;
        }

        .task-deadline {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        /* Notice List */
        .notice-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notice-item {
            padding: 12px;
            border-radius: 8px;
            background: #f8fafc;
            border-left: 3px solid #073379;
        }

        .notice-title {
            font-size: 13px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .notice-date {
            font-size: 11px;
            color: #64748b;
        }

        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification-item {
            padding: 12px;
            border-radius: 8px;
            background: #f8fafc;
            border-left: 3px solid #2563eb;
        }

        .notification-item.unread {
            background: #eef4ff;
            border-left-color: #073379;
        }

        .notification-title {
            font-size: 13px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 12px;
            color: #475569;
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 11px;
            color: #64748b;
        }

        /* Leave Status */
        .leave-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .leave-label {
            font-size: 13px;
            color: #64748b;
        }

        .leave-value {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
        }

        .leave-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-approved {
            background: #d1fae5;
            color: #059669;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Project Progress */
        .progress-item {
            margin-bottom: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .progress-label {
            font-size: 13px;
            color: #1e293b;
            font-weight: 500;
        }

        .progress-percent {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, #073379 0%, #1e40af 100%);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .action-btn {
            padding: 12px;
            border-radius: 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .action-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .action-icon {
            font-size: 18px;
            color: #073379;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            #tracker-container {
                position: fixed;
                bottom: 0;
                top: auto;
                right: 0;
                left: 0;
                width: 100%;
                height: auto;
                border-left: none;
                border-top: 1px solid #e2e8f0;
                padding: 12px;
                z-index: 1001;
            }

            .main-content {
                margin-right: 0;
                margin-bottom: 80px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 16px;
            }

            #sidebar-container {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            #sidebar-container.active {
                transform: translateX(0);
            }

            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .page-title {
                font-size: 20px;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>
    <div id="tracker-container"></div>

    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">My Dashboard</h1>
            <div class="welcome-message" id="welcomeMessage">Welcome back, <strong>Employee</strong></div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-value" id="total-tasks">0</div>
                <div class="kpi-label">My Tasks</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="completed-tasks">0</div>
                <div class="kpi-label">Completed</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="pending-tasks">0</div>
                <div class="kpi-label">Pending</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="projects-count">0</div>
                <div class="kpi-label">Projects</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- My Tasks -->
            <div class="card compact">
                <div class="card-header">
                    <h2 class="card-title">My Recent Tasks</h2>
                    <a href="tasks.html" class="card-link">View All</a>
                </div>
                <div class="task-list" id="recentTasksList">
                    <div class="task-item">
                        <div class="task-name">Loading tasks...</div>
                    </div>
                </div>
            </div>

            <!-- Project Progress -->
            <div class="card compact">
                <div class="card-header">
                    <h2 class="card-title">My Projects Progress</h2>
                </div>
                <div id="projectProgressList">
                    <div class="progress-item">
                        <div class="progress-header">
                            <div class="progress-label">Loading projects...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Status -->
            <div class="card compact">
                <div class="card-header">
                    <h2 class="card-title">Leave Status</h2>
                    <a href="leaves.html" class="card-link">View All</a>
                </div>
                <div class="leave-status">
                    <span class="leave-label">Leaves Taken</span>
                    <span class="leave-value" id="leaves-taken">0</span>
                </div>
                <div class="leave-status">
                    <span class="leave-label">Leaves Remaining</span>
                    <span class="leave-value" id="leaves-remaining">0</span>
                </div>
                <div id="recentLeavesList"></div>
            </div>

            <!-- Recent Notices -->
            <div class="card compact">
                <div class="card-header">
                    <h2 class="card-title">Recent Notices</h2>
                    <a href="notices.html" class="card-link">View All</a>
                </div>
                <div class="notice-list" id="noticeList">
                    <div class="notice-item">
                        <div class="notice-title">Loading notices...</div>
                    </div>
                </div>
            </div>

            <div class="card compact">
                <div class="card-header">
                    <h2 class="card-title">Recent Notifications</h2>
                </div>
                <div class="notification-list" id="notificationList">
                    <div class="notification-item">
                        <div class="notification-title">Loading notifications...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Quick Actions</h2>
            </div>
            <div class="quick-actions">
                <a href="tasks.html" class="action-btn">
                    <span class="action-icon">üìã</span>
                    View Tasks
                </a>
                <a href="attendance.html" class="action-btn">
                    <span class="action-icon">‚è∞</span>
                    Mark Attendance
                </a>
                <a href="leaves.html" class="action-btn">
                    <span class="action-icon">üå¥</span>
                    Apply Leave
                </a>
                <a href="profile.html" class="action-btn">
                    <span class="action-icon">üë§</span>
                    My Profile
                </a>
            </div>
        </div>
    </div>

    <script>
        // Load sidebar
        fetch("../shared/sidebar_employee.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("sidebar-container").innerHTML = html;

                const current = location.pathname.split("/").pop();
                document.querySelectorAll(".sidebar a").forEach(link => {
                    if (link.getAttribute("href")?.includes(current)) {
                        link.classList.add("active");
                    }
                });
            })
            .catch(err => console.error("Failed to load sidebar:", err));

        // Helper functions
        function safeText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function formatDate(dateStr) {
            if (!dateStr) return "-";
            const d = new Date(dateStr);
            return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        }

        function escapeHtml(v) {
            if (v === null || v === undefined) return "";
            return String(v)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return "-";
            const d = new Date(dateStr);
            return d.toLocaleString("en-US", {
                month: "short",
                day: "numeric",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        function getStatusClass(status) {
            switch(status?.toLowerCase()) {
                case 'pending': return 'status-pending';
                case 'in_progress': return 'status-in_progress';
                case 'completed': return 'status-completed';
                case 'overdue': return 'status-overdue';
                default: return 'status-pending';
            }
        }

        function renderNotifications(notifications) {
            const notificationsEl = document.getElementById("notificationList");
            if (!notificationsEl) return;

            if (!notifications || notifications.length === 0) {
                notificationsEl.innerHTML = '<div class="notification-item"><div class="notification-title">No notifications yet</div></div>';
                return;
            }

            notificationsEl.innerHTML = notifications.slice(0, 8).map(n => `
                <div class="notification-item ${n.is_read ? "" : "unread"}">
                    <div class="notification-title">${escapeHtml(n.title || "Notification")}</div>
                    <div class="notification-message">${escapeHtml(n.message || "")}</div>
                    <div class="notification-time">${formatDateTime(n.created_at)}</div>
                </div>
            `).join("");
        }

        async function loadNotifications() {
            if (!window.API || typeof API.getMyNotifications !== "function") return;
            try {
                const notifications = await API.getMyNotifications(8, false);
                renderNotifications(notifications || []);
            } catch (err) {
                console.error("Failed to load notifications:", err);
            }
        }

        // Load employee dashboard data
        async function loadEmployeeDashboard() {
            if (!localStorage.getItem("access_token")) {
                window.location.href = "../auth/login.html";
                return;
            }
            
            if (!window.API) return;

            try {
                // Get user info for welcome message
                const userStr = localStorage.getItem("user");
                if (userStr) {
                    const user = JSON.parse(userStr);
                    document.getElementById("welcomeMessage").innerHTML = `Welcome back, <strong>${escapeHtml(user.name || 'Employee')}</strong>`;
                }

                // Fetch all required data
                const [tasks, projects, leaves, notices] = await Promise.all([
                    API.getMyTasks(10, false),
                    API.getMyProjects(),
                    API.getMyLeaves(),
                    API.getNotices()
                ]);

                const taskList = tasks || [];
                const projectList = projects || [];
                const leaveList = leaves || [];
                const noticeList = notices || [];

                // Update task stats
                const totalTasks = taskList.length;
                const completedTasks = taskList.filter(t => t.status === "completed").length;
                const pendingTasks = taskList.filter(t => t.status !== "completed").length;

                safeText("total-tasks", totalTasks);
                safeText("completed-tasks", completedTasks);
                safeText("pending-tasks", pendingTasks);
                safeText("projects-count", projectList.length);

                // Calculate leave stats (assuming 20 total leaves per year)
                const totalLeavesPerYear = 20;
                const approvedLeaves = leaveList.filter(l => l.status === "approved").length;
                const leavesTaken = approvedLeaves;
                const leavesRemaining = totalLeavesPerYear - leavesTaken;

                safeText("leaves-taken", leavesTaken);
                safeText("leaves-remaining", leavesRemaining);

                // Render recent tasks
                const recentTasksEl = document.getElementById("recentTasksList");
                if (recentTasksEl) {
                    if (taskList.length === 0) {
                        recentTasksEl.innerHTML = '<div class="task-item"><div class="task-name">No tasks assigned</div></div>';
                    } else {
                        recentTasksEl.innerHTML = taskList.slice(0, 5).map(t => `
                            <div class="task-item">
                                <div class="task-status ${getStatusClass(t.status)}"></div>
                                <div class="task-info">
                                    <div class="task-name">${escapeHtml(t.title || "Untitled Task")}</div>
                                    <div class="task-project">${escapeHtml(t.project_name || "No Project")}</div>
                                </div>
                                <div class="task-deadline">${t.due_date ? formatDate(t.due_date) : 'No deadline'}</div>
                            </div>
                        `).join("");
                    }
                }

                // Render project progress
                const projectProgressEl = document.getElementById("projectProgressList");
                if (projectProgressEl) {
                    if (projectList.length === 0) {
                        projectProgressEl.innerHTML = '<div class="progress-item"><div class="progress-label">No projects assigned</div></div>';
                    } else {
                        projectProgressEl.innerHTML = projectList.slice(0, 4).map(p => {
                            const projectTasks = taskList.filter(t => Number(t.project_id) === Number(p.id));
                            const total = projectTasks.length;
                            const done = projectTasks.filter(t => t.status === "completed").length;
                            const pct = total ? Math.round((done / total) * 100) : 0;
                            return `
                                <div class="progress-item">
                                    <div class="progress-header">
                                        <div class="progress-label">${escapeHtml(p.name || "Untitled Project")}</div>
                                        <div class="progress-percent">${pct}%</div>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                                </div>
                            `;
                        }).join("");
                    }
                }

                // Render recent leaves
                const recentLeavesEl = document.getElementById("recentLeavesList");
                if (recentLeavesEl) {
                    if (leaveList.length === 0) {
                        recentLeavesEl.innerHTML = '<div class="notice-item">No leave applications</div>';
                    } else {
                        recentLeavesEl.innerHTML = leaveList.slice(0, 3).map(l => `
                            <div class="notice-item">
                                <div class="notice-title">${escapeHtml(l.leave_type || "Leave")} - ${formatDate(l.start_date)}</div>
                                <div class="notice-date">
                                    Status: <span class="leave-badge badge-${l.status || 'pending'}">${escapeHtml(l.status || 'pending')}</span>
                                </div>
                            </div>
                        `).join("");
                    }
                }

                // Render notices
                const noticesEl = document.getElementById("noticeList");
                if (noticesEl) {
                    if (noticeList.length === 0) {
                        noticesEl.innerHTML = '<div class="notice-item">No notices available</div>';
                    } else {
                        noticesEl.innerHTML = noticeList.slice(0, 4).map(n => `
                            <div class="notice-item">
                                <div class="notice-title">${escapeHtml(n.title || "Notice")}</div>
                                <div class="notice-date">Posted ${formatDate(n.created_at)}</div>
                            </div>
                        `).join("");
                    }
                }

                await loadNotifications();

            } catch (err) {
                console.error("Dashboard load failed:", err);
            }
        }

        // Initialize dashboard
        document.addEventListener("DOMContentLoaded", function() {
            loadEmployeeDashboard();
            window.addEventListener("employee-notification-new", () => loadNotifications());
            window.addEventListener("employee-notification-removed", () => loadNotifications());
            window.addEventListener("employee-notification-cleared", () => loadNotifications());
            window.addEventListener("employee-notification-read-all", () => loadNotifications());
            
            // Refresh every 30 seconds
            setInterval(loadEmployeeDashboard, 30000);
        });
    </script>

    <!-- Load API and Tracker -->
    <script src="../../static/js/api.js"></script>
    <script src="../../static/js/tracker.js"></script>
    <script src="../../static/js/loadTracker.js"></script>
    
    <!-- Load Chat Component exactly like admin side -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetch("../shared/chat.html")
                .then(res => res.text())
                .then(html => {
                    const host = document.createElement("div");
                    host.innerHTML = html;

                    const scripts = Array.from(host.querySelectorAll("script")).map(oldScript => {
                        const newScript = document.createElement("script");
                        if (oldScript.src) {
                            newScript.src = oldScript.src;
                        } else {
                            newScript.textContent = oldScript.textContent;
                        }
                        oldScript.remove();
                        return newScript;
                    });

                    while (host.firstChild) {
                        document.body.appendChild(host.firstChild);
                    }

                    scripts.forEach(script => document.body.appendChild(script));
                })
                .catch(err => console.error("Failed to load chat component:", err));
        });
    </script>
</body>
</html>
